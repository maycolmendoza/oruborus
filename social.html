<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  /* ================== THEME TOKENS ================== */
  :root{
    --bg: #f6f7fb; --txt:#111827; --muted:#6b7280;
    --glass-bg: rgba(255,255,255,.20); --glass-border: rgba(255,255,255,.40); --shadow: 0 18px 46px rgba(15,23,42,.18);
    --g1:#60a5fa; --g2:#22d3ee; --g3:#a78bfa;            /* grad icon default */
    --card-bg: rgba(255,255,255,.65); --card-bd: rgba(17,24,39,.06);
    --btn:clamp(38px,4.6vw,54px); --icon:clamp(16px,2.2vw,22px); --gap:clamp(8px,1.6vw,16px);
    --barH:clamp(50px,6.6vw,70px); --pad:clamp(6px,1.2vw,10px); --radius:20px;
    --tip-bg: rgba(15,23,42,.92); --tip-bd: rgba(255,255,255,.18);
    --shrink-shift:-2px;
  }
  /* DARK */
  .theme-dark{
    --bg:#0b1220; --txt:#e5e7eb; --muted:#9ca3af;
    --glass-bg: rgba(16,20,32,.55); --glass-border: rgba(255,255,255,.12); --shadow: 0 18px 46px rgba(0,0,0,.45);
    --g1:#8ab4ff; --g2:#67e8f9; --g3:#c084fc;
    --card-bg: rgba(17,24,39,.55); --card-bd: rgba(255,255,255,.06);
  }
  /* ESPECIE (cambia paleta de iconos y highlights) */
  .species-cat{ --g1:#fb7185; --g2:#f0abfc; --g3:#60a5fa; }   /* coral/rosa/azul */
  .species-dog{ --g1:#f59e0b; --g2:#34d399; --g3:#60a5fa; }   /* √°mbar/verde/azul */

  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    padding-top: calc(var(--barH) + 18px);
    background:
      radial-gradient(1200px 600px at 15% -10%, #e7f1ff 0%, transparent 60%),
      radial-gradient(1000px 500px at 100% 0%, #ffe6fb 0%, transparent 60%),
      var(--bg);
    transition: background .35s ease, color .2s ease;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .theme-dark{
    background:
      radial-gradient(1000px 500px at 100% -10%, rgba(198,114,255,.10) 0%, transparent 60%),
      radial-gradient(900px 450px at -10% 0%, rgba(96,165,250,.12) 0%, transparent 60%),
      var(--bg);
  }
  @media (max-width:768px){ :root{ --shrink-shift: 2px; } body{ padding-top:0; padding-bottom: calc(var(--barH) + 18px);} }

  /* ================== DOCK GLASS ================== */
  .dock-wrap{
    position: fixed; left:50%; top:10px; transform: translateX(-50%) translateY(0);
    height: var(--barH); padding: var(--pad);
    border-radius: var(--radius);
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    -webkit-backdrop-filter: blur(22px) saturate(160%);
    backdrop-filter: blur(22px) saturate(160%);
    box-shadow: var(--shadow);
    z-index: 1000;
    overflow: visible;
    transition: background .35s ease, transform .35s ease, opacity .25s ease;
  }
  .dock-wrap::before{ content:""; position:absolute; inset:0; pointer-events:none; border-radius: inherit; background: linear-gradient(180deg, rgba(255,255,255,.50), rgba(255,255,255,0) 38%); }
  .dock-wrap::after{ content:""; position:absolute; inset:0; pointer-events:none; border-radius: inherit; box-shadow: inset 0 0 0 1px rgba(255,255,255,.18); }
  .dock-wrap.shrink{ padding: calc(var(--pad) - 2px); transform: translateX(-50%) translateY(var(--shrink-shift)); background: color-mix(in oklab, var(--glass-bg) 85%, #fff 20%); }
  .dock{ display:flex; align-items:center; gap: var(--gap); height:100%; position:relative; padding-inline: 2px; }

  .active-bg{
    position:absolute; z-index:0; width: var(--btn); height: var(--btn);
    top:50%; left:0; transform: translateY(-50%);
    border-radius: 14px;
    background: radial-gradient(130% 130% at 30% 25%, rgba(255,255,255,.55), rgba(255,255,255,.12) 60%, transparent 100%);
    border: 1px solid rgba(255,255,255,.30);
    box-shadow: 0 10px 24px rgba(0,0,0,.14), inset 0 0 0 1px rgba(255,255,255,.14);
    transition: transform .35s cubic-bezier(.18,.89,.32,1.28), width .25s ease;
  }
  .dock-btn{
    position:relative; z-index:1; width: var(--btn); height: var(--btn);
    display:grid; place-items:center; background: transparent;
    border: 1px solid color-mix(in oklab, var(--txt) 10%, transparent);
    border-radius: 14px; cursor:pointer; transition: transform .16s ease, border-color .16s ease, box-shadow .16s ease;
  }
  .dock-btn:hover{ transform: translateY(-1px); border-color: color-mix(in oklab, var(--txt) 18%, transparent); box-shadow: 0 8px 18px rgba(0,0,0,.10); }
  .dock-btn.is-active{ border-color: transparent; box-shadow:none; }
  .dock-btn i{
    font-size: var(--icon); line-height:1;
    background: linear-gradient(45deg, var(--g1), var(--g2), var(--g3)); background-size: 180% 180%;
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color: transparent; color: transparent;
    filter: drop-shadow(0 1px 4px rgba(96,165,250,.32));
    transition: background-position .35s ease, filter .16s ease, transform .16s ease;
  }
  .dock-btn:hover i{ background-position: 100% 0; filter: drop-shadow(0 3px 10px rgba(96,165,250,.42)); }
  .dock-btn.is-active i{ transform: translateY(-1px); }

  /* tooltips inteligentes */
  .dock-btn[data-tip]::after,.dock-btn[data-tip]::before{ position:absolute; left:50%; opacity:0; pointer-events:none; transition: opacity .18s ease, transform .18s ease; z-index:2000; }
  .dock-btn[data-tip]::after{
    content: attr(data-tip); background: var(--tip-bg); color:#fff; font-size:.72rem; padding:6px 8px; white-space:nowrap; border-radius:8px;
    border:1px solid var(--tip-bd); -webkit-backdrop-filter: blur(8px) saturate(130%); backdrop-filter: blur(8px) saturate(130%);
  }
  .dock-btn[data-tip]::before{ content:""; border:6px solid transparent; z-index:1999; }
  .dock-btn:hover::after, .dock-btn:hover::before{ opacity:1; }
  .tip-above .dock-btn[data-tip]::after{ top:-8px; transform: translate(-50%, -100%); }
  .tip-above .dock-btn[data-tip]::before{ top:-8px; transform: translate(-50%, -100%); border-top-color: var(--tip-bg); }
  .tip-below .dock-btn[data-tip]::after{ bottom:-8px; transform: translate(-50%, 100%); }
  .tip-below .dock-btn[data-tip]::before{ bottom:-8px; transform: translate(-50%, 100%); border-bottom-color: var(--tip-bg); }

  @media (max-width:768px){ .dock-wrap{ top:auto; bottom:10px; } }

  /* ================== LAYOUT / SECCIONES ================== */
  main{ max-width: 1200px; margin: 20px auto 80px; padding: 0 16px; }
  .title{ font-weight:800; letter-spacing:.2px; font-size:clamp(22px, 2.6vw, 28px); margin: 8px 0 16px; }
  .muted{ color:var(--muted); font-size:.92rem; }
  .grid{ display:grid; gap:16px; grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) ); }

  .card{ border-radius: 16px; overflow:hidden; background: var(--card-bg); border:1px solid var(--card-bd); box-shadow: 0 8px 24px rgba(0,0,0,.06); transition: transform .18s ease, box-shadow .18s ease; }
  .card:hover{ transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,.10); }
  .card__media{ height:140px; background: linear-gradient(135deg, #e8f0ff, #fbe8ff); }
  .theme-dark .card__media{ background: linear-gradient(135deg, #173055, #321a4d); }
  .card__body{ padding:14px; }
  .card__title{ font-weight:700; margin-bottom:6px; }
  .card__meta{ color:var(--muted); font-size:.88rem; display:flex; gap:10px; align-items:center; }

  .skeleton{ position:relative; overflow:hidden; background: var(--card-bg); border:1px solid var(--card-bd); border-radius:16px; }
  .sk-media{ height:140px; background: color-mix(in oklab, var(--bg) 92%, #ccc 8%); }
  .sk-line{ height:12px; border-radius:6px; background: color-mix(in oklab, var(--bg) 88%, #bbb 12%); margin:10px 14px; }
  .sk-line.w60{ width:60% } .sk-line.w40{ width:40% } .sk-line.w80{ width:80% }
  .skeleton::after{ content:""; position:absolute; inset:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); transform: translateX(-100%); animation: shimmer 1.2s infinite; }
  @keyframes shimmer{ to{ transform: translateX(100%);} }

  .btn{ display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; border:1px solid var(--card-bd); background: var(--card-bg); color:var(--txt); cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.06); transition: transform .15s ease, box-shadow .15s ease; }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.10); }

  /* ================== ONBOARDING (ID COLLAR) ================== */
  .overlay{
    position:fixed; inset:0; z-index:1100; display:grid; place-items:center;
    background: radial-gradient(1200px 600px at 10% -10%, rgba(96,165,250,.15), transparent 60%), rgba(0,0,0,.25);
    backdrop-filter: blur(8px);
    transition: opacity .35s ease, visibility .35s ease;
  }
  .overlay.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
  .card-modal{
    width:min(560px, 92%); border-radius:18px; padding:18px; border:1px solid rgba(255,255,255,.3);
    background: rgba(255,255,255,.7); backdrop-filter: blur(14px);
    box-shadow: 0 18px 50px rgba(0,0,0,.25); color:#111;
  }
  .card-modal h2{ margin:.2rem 0 .6rem; font-size:1.3rem; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .row > *{ flex:1 1 180px; }
  .input, .select{
    width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(17,24,39,.15); background:#fff; font-size:1rem;
  }

  .species-toggle{ display:flex; gap:10px; }
  .species-toggle label{
    flex:1; padding:10px 12px; border:1px solid rgba(17,24,39,.15); border-radius:12px; cursor:pointer; display:flex; gap:8px; align-items:center; justify-content:center; background:#fff;
  }
  .species-toggle input{ display:none; }
  .species-toggle input:checked + span{ color:#0b5; font-weight:700; }

  .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  .btn-primary{ background:#111827; color:#fff; border:none; }
  .btn-ghost{ background:transparent; }

  /* ================== SPLASH ================== */
  .splash{
    position:fixed; inset:0; z-index:1050; display:grid; place-items:center;
    background: radial-gradient(800px 500px at 50% -10%, rgba(255,255,255,.6), transparent 70%), var(--bg);
    transition: opacity .35s ease, visibility .35s ease;
  }
  .splash.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
  .paw{
    width:84px; height:84px; border-radius:24px; display:grid; place-items:center;
    background: linear-gradient(145deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
    border:1px solid rgba(255,255,255,.45); backdrop-filter: blur(12px);
    box-shadow: 0 12px 30px rgba(0,0,0,.08);
    animation: pop 900ms ease-in-out infinite alternate;
  }
  .paw i{ font-size:42px; background: linear-gradient(45deg, var(--g1), var(--g2), var(--g3)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color: transparent; }
  @keyframes pop { from{ transform: scale(.96)} to{ transform: scale(1.04)} }

  /* ================== PERFIL ================== */
  .form{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  .form .field{ display:flex; flex-direction:column; gap:6px; }
  .form label{ font-size:.92rem; color:var(--muted); }
  .avatar{
    width:120px; height:120px; border-radius:50%; border:2px dashed var(--card-bd); display:grid; place-items:center; overflow:hidden; background:var(--card-bg);
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; }

  /* ================== MAPA ================== */
  #map{ height:360px; border-radius:16px; border:1px solid var(--card-bd); overflow:hidden; }
  .leaflet-container{ background: var(--bg); }

  /* ================== REPORTE ================== */
  .report{
    border-radius:20px; padding:16px; background: var(--card-bg); border:1px solid var(--card-bd);
    display:grid; gap:14px; grid-template-columns: 140px 1fr;
  }
  .report .photo{ width:140px; height:140px; border-radius:16px; overflow:hidden; border:1px solid var(--card-bd); }
  .report .photo img{ width:100%; height:100%; object-fit:cover; }
  .badge-lost{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    background: rgba(239,68,68,.12); color:#ef4444; border:1px solid rgba(239,68,68,.35);
  }
</style>
</head>

<body>
  <!-- ================== DOCK ================== -->
  <header class="dock-wrap tip-below" id="dockWrap">
    <nav class="dock" id="dock">
      <button class="dock-btn is-active" data-tip="Inicio"        onclick="selectDock(this); loadSection('inicio')"><i class="bi bi-house-door-fill"></i></button>
      <button class="dock-btn"          data-tip="Salud"         onclick="selectDock(this); loadSection('salud')"><i class="bi bi-activity"></i></button>
      <button class="dock-btn"          data-tip="Dieta"         onclick="selectDock(this); loadSection('dieta')"><i class="bi bi-egg-fried"></i></button>
      <button class="dock-btn"          data-tip="Perfil"        onclick="selectDock(this); loadSection('perfil')"><i class="bi bi-person-badge-fill"></i></button>
      <button class="dock-btn"          data-tip="Mapa"          onclick="selectDock(this); loadSection('mapa')"><i class="bi bi-geo-alt-fill"></i></button>
      <button class="dock-btn"          data-tip="Reporte"       onclick="selectDock(this); loadSection('reporte')"><i class="bi bi-file-earmark-text-fill"></i></button>
      <!-- toggle tema -->
      <button class="dock-btn" id="themeBtn" data-tip="Modo oscuro" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i></button>

      <span class="active-bg" id="activeBg"></span>
    </nav>
  </header>

  <!-- ================== ONBOARDING (ID COLLAR) ================== -->
  <div class="overlay" id="onboarding">
    <div class="card-modal">
      <h2>Activa tu collar</h2>
      <p class="muted" style="margin-bottom:10px">Ingresa el <b>ID del collar</b> para personalizar la app para tu mascota.</p>
      <div class="row">
        <input id="collarId" class="input" placeholder="Ej: CAT-5271 o DOG-9012"/>
        <div class="species-toggle">
          <label><input type="radio" name="species" value="cat" checked/><span>üê± Gato</span></label>
          <label><input type="radio" name="species" value="dog"/><span>üê∂ Perro</span></label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="autoDetect()">Detectar</button>
        <button class="btn btn-primary" onclick="startApp()">Empezar</button>
      </div>
      <p class="muted" style="margin-top:6px">Tip: prefijos habituales <b>CAT-</b> o <b>DOG-</b>. Puedes elegir manualmente.</p>
    </div>
  </div>

  <!-- ================== SPLASH (loader) ================== -->
  <div class="splash hidden" id="splash">
    <div class="paw"><i class="bi bi-boombox"></i></div>
  </div>

  <!-- ================== CONTENIDO ================== -->
  <main id="main">
    <h1 class="title" id="pageTitle">Inicio</h1>
    <p class="muted" id="pageDesc">Cargando recomendaciones‚Ä¶</p>
    <section id="content" class="grid"></section>
    <div style="margin:22px 0"><button class="btn" onclick="loadMore()">Cargar m√°s <i class="bi bi-arrow-down-circle"></i></button></div>
  </main>

<script>
  /* ===== DOCK / UI base ===== */
  const wrap = document.getElementById('dockWrap');
  const dock = document.getElementById('dock');
  const bg   = document.getElementById('activeBg');
  const btns = [...dock.querySelectorAll('.dock-btn')];
  function moveBgTo(el){ const g=dock.getBoundingClientRect(), b=el.getBoundingClientRect(); const left=b.left-g.left+(dock.scrollLeft||0); bg.style.width=b.width+'px'; bg.style.transform=`translate(${left}px, -50%)`; }
  function selectDock(btn){ btns.forEach(b=>b.classList.remove('is-active')); btn.classList.add('is-active'); moveBgTo(btn); }
  function updateTooltipSide(){ const r=wrap.getBoundingClientRect(); const showBelow=(r.top < (innerHeight - r.bottom) - 24); wrap.classList.toggle('tip-below', showBelow); wrap.classList.toggle('tip-above', !showBelow); }
  addEventListener('scroll', ()=>{ wrap.classList.toggle('shrink', window.scrollY>8); updateTooltipSide(); });
  addEventListener('resize', ()=>{ moveBgTo(dock.querySelector('.is-active')||btns[0]); updateTooltipSide(); });

  /* ===== THEME ===== */
  const THEME_KEY='pref-theme'; const themeBtn=document.getElementById('themeBtn'); const themeIcon=document.getElementById('themeIcon');
  function applyTheme(mode){ document.documentElement.classList.toggle('theme-dark', mode==='dark'); themeIcon.className = mode==='dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill'; themeBtn.setAttribute('data-tip', mode==='dark' ? 'Modo claro':'Modo oscuro'); localStorage.setItem(THEME_KEY, mode); }
  function toggleTheme(){ const cur=document.documentElement.classList.contains('theme-dark')?'dark':'light'; applyTheme(cur==='dark'?'light':'dark'); }
  function initTheme(){ applyTheme(localStorage.getItem(THEME_KEY)||'light'); }

  /* ===== SPECIES / COLLAR ===== */
  const SPECIES_KEY='collar-species'; const COLLAR_KEY='collar-id';
  const onboarding=document.getElementById('onboarding'); const splash=document.getElementById('splash');
  function autoDetect(){
    const v=(document.getElementById('collarId').value||'').trim().toUpperCase();
    const cat=v.startsWith('CAT-')||v.startsWith('GAT-')||v.startsWith('G');
    const dog=v.startsWith('DOG-')||v.startsWith('PER-')||v.startsWith('P')||v.startsWith('D');
    const radios=[...document.querySelectorAll('input[name="species"]')];
    if (cat) radios.find(r=>r.value==='cat').checked=true;
    else if (dog) radios.find(r=>r.value==='dog').checked=true;
  }
  function startApp(){
    const id=(document.getElementById('collarId').value||'').trim();
    const species=([...document.querySelectorAll('input[name="species"]')].find(r=>r.checked)||{value:'cat'}).value;
    if (!id){ alert('Ingresa el ID del collar'); return; }
    localStorage.setItem(COLLAR_KEY, id);
    localStorage.setItem(SPECIES_KEY, species);
    applySpecies(species);
    onboarding.classList.add('hidden');
    splash.classList.remove('hidden');
    setTimeout(()=>{ splash.classList.add('hidden'); loadSection('inicio'); }, 900);
  }
  function applySpecies(s){
    document.documentElement.classList.remove('species-cat','species-dog');
    document.documentElement.classList.add(s==='cat'?'species-cat':'species-dog');
  }

  /* ===== DATA FAKE SEG√öN ESPECIE ===== */
  const copy = {
    cat: {
      inicio: ['Rascadores top','Juguetes con catnip','Consejos de cepillado','Areneros recomendados','Rutinas indoor','Snacks felinos'],
      salud:  ['Vacunas b√°sicas felinas','Desparasitaci√≥n','Signos de alerta','Cuidados post esterilizaci√≥n','Higiene ocular y auricular'],
      dieta:  ['Alimentaci√≥n por etapas','H√∫medo vs seco','Raciones diarias','Agua y fuentes','Suplementos comunes'],
    },
    dog: {
      inicio: ['Arneses y correas','Juguetes resistentes','Paseo seguro','Adiestramiento b√°sico','Camas ortop√©dicas','Snacks saludables'],
      salud:  ['Vacunas caninas','Desparasitaci√≥n','Cuidados dentales','Prevenci√≥n de pulgas','Esterilizaci√≥n'],
      dieta:  ['Balance por talla','Pienso vs BARF','Raciones y horarios','Hidrataci√≥n','Suplementos habituales'],
    }
  };

  /* ===== GRID / SKELETON ===== */
  const grid=document.getElementById('content'); const pageTitle=document.getElementById('pageTitle'); const pageDesc=document.getElementById('pageDesc');
  const rand = a => a[Math.floor(Math.random()*a.length)];
  const pics = ['linear-gradient(135deg,#e8f0ff,#fbe8ff)','linear-gradient(135deg,#ffe7e7,#e7fff7)','linear-gradient(135deg,#e7f7ff,#efe7ff)','linear-gradient(135deg,#fff3d4,#e4f0ff)'];
  function skeleton(n=8){ const f=document.createDocumentFragment(); for(let i=0;i<n;i++){ const s=document.createElement('article'); s.className='skeleton'; s.innerHTML=`<div class="sk-media"></div><div class="sk-line w80"></div><div class="sk-line w60"></div><div class="sk-line w40"></div>`; f.appendChild(s);} return f; }
  function cardList(titles){ const f=document.createDocumentFragment(); titles.forEach(t=>{ const el=document.createElement('article'); el.className='card'; el.innerHTML=`<div class="card__media" style="background:${rand(pics)}"></div><div class="card__body"><div class="card__title">${t}</div><div class="card__meta"><i class="bi bi-clock"></i><span>${new Date().toLocaleDateString()}</span></div></div>`; f.appendChild(el); }); return f; }
  function loadMore(){ grid.appendChild(skeleton(6)); setTimeout(()=>{ [...grid.querySelectorAll('.skeleton')].slice(-6).forEach(n=>n.remove()); const sp=localStorage.getItem(SPECIES_KEY)||'cat'; grid.appendChild(cardList([rand(copy[sp].inicio),rand(copy[sp].inicio),rand(copy[sp].inicio)])); }, 600); }

  /* ===== PERFIL ===== */
  const PROFILE_KEY='pet-profile'; const LOST_KEY='pet-lost';
  function renderPerfil(){
    pageTitle.textContent='Perfil'; pageDesc.textContent='Completa los datos de tu mascota.';
    grid.innerHTML='';
    const saved = JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}');
    const lost  = JSON.parse(localStorage.getItem(LOST_KEY)||'{"lost":false}');
    const card=document.createElement('article'); card.className='card'; card.innerHTML=`
      <div class="card__body">
        <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px">
          <div class="avatar"><img id="avatarImg" src="${saved.photo||''}" alt="" onerror="this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;120&quot; height=&quot;120&quot;><rect width=&quot;100%&quot; height=&quot;100%&quot; fill=&quot;%23ddd&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; fill=&quot;%23999&quot; font-family=&quot;Arial&quot; font-size=&quot;14&quot;>Sin foto</text></svg>'"/></div>
          <div><label class="btn"><i class="bi bi-upload"></i> Subir foto<input id="avatarInput" type="file" accept="image/*" style="display:none"/></label></div>
        </div>
        <div class="form">
          <div class="field"><label>Nombre *</label><input id="pName" class="input" value="${saved.name||''}" placeholder="Ej. Mishi / Firulais" required></div>
          <div class="field"><label>Edad (a√±os) *</label><input id="pAge" type="number" min="0" class="input" value="${saved.age||''}" placeholder="Ej. 3" required></div>
          <div class="field"><label>Raza</label><input id="pBreed" class="input" value="${saved.breed||''}" placeholder="Opcional"></div>
          <div class="field"><label>WhatsApp</label><input id="pPhone" class="input" value="${saved.phone||''}" placeholder="+51 999 999 999"></div>
          <div class="field"><label>Email</label><input id="pEmail" class="input" value="${saved.email||''}" placeholder="correo@dominio.com"></div>
          <div class="field"><label>Notas</label><input id="pNotes" class="input" value="${saved.notes||''}" placeholder="Alergias, temperamento, etc."></div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; margin-top:12px">
          <label class="btn"><i class="bi bi-save2"></i> Guardar</label>
          <label style="display:inline-flex; align-items:center; gap:8px; margin-left:12px">
            <input id="lostToggle" type="checkbox" ${lost.lost?'checked':''}/> <span>Marcar como perdido</span>
          </label>
        </div>
      </div>`;
    grid.appendChild(card);

    // handlers
    const input=document.getElementById('avatarInput'), img=document.getElementById('avatarImg');
    input.onchange = e => { const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload = ()=>{ img.src=reader.result; }; reader.readAsDataURL(file); };
    card.querySelector('.btn').onclick = saveProfile;
    document.getElementById('lostToggle').onchange = (e)=> setLost(e.target.checked);
  }
  function saveProfile(){
    const photo=document.getElementById('avatarImg').src;
    const name=document.getElementById('pName').value.trim();
    const age =document.getElementById('pAge').value.trim();
    if(!photo || photo.startsWith('data:image/svg')){ alert('La foto de perfil es obligatoria.'); return; }
    if(!name){ alert('El nombre es obligatorio.'); return; }
    if(age==='' || Number(age)<0){ alert('Edad inv√°lida.'); return; }
    const data={ photo,name,age, breed:val('pBreed'), phone:val('pPhone'), email:val('pEmail'), notes:val('pNotes') };
    localStorage.setItem(PROFILE_KEY, JSON.stringify(data));
    alert('Perfil guardado ‚úÖ');
  }
  function setLost(flag){
    const cur = JSON.parse(localStorage.getItem(LOST_KEY)||'{}');
    if(flag && !cur.lost_since) cur.lost_since = new Date().toISOString();
    const out = { lost: !!flag, lost_since: flag ? cur.lost_since : null };
    localStorage.setItem(LOST_KEY, JSON.stringify(out));
  }
  const val=id=>document.getElementById(id).value.trim();

  /* ===== MAPA ===== */
  const MAP_KEY='pet-locations';
  let map, markers=[];
  function renderMapa(){
    pageTitle.textContent='Mapa'; pageDesc.textContent='√öltimas ubicaciones vistas.';
    grid.innerHTML='';
    const card=document.createElement('article'); card.className='card'; card.innerHTML=`
      <div class="card__body">
        <div id="map"></div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button class="btn" id="btnHere"><i class="bi bi-geo-fill"></i> Marcar ubicaci√≥n actual</button>
          <input class="input" id="lat" placeholder="Latitud" style="max-width:160px">
          <input class="input" id="lng" placeholder="Longitud" style="max-width:160px">
          <button class="btn" id="btnAdd"><i class="bi bi-plus-circle"></i> Agregar marca</button>
        </div>
      </div>`;
    grid.appendChild(card);

    setTimeout(()=>{ // init Leaflet
      map = L.map('map').setView([-12.0464, -77.0428], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution:'¬© OSM' }).addTo(map);
      loadMarkers();
      document.getElementById('btnHere').onclick = addHere;
      document.getElementById('btnAdd').onclick  = addManual;
    }, 50);
  }
  function loadMarkers(){
    markers.forEach(m=>map.removeLayer(m)); markers=[];
    const data = JSON.parse(localStorage.getItem(MAP_KEY)||'[]');
    data.forEach(p=>{ const m=L.marker([p.lat,p.lng]).addTo(map).bindPopup(`<b>Visto</b><br>${new Date(p.t).toLocaleString()}`); markers.push(m); });
    if (data[0]) map.setView([data[data.length-1].lat, data[data.length-1].lng], 14);
  }
  function addHere(){
    if(!navigator.geolocation){ alert('Geolocalizaci√≥n no soportada'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      savePoint(pos.coords.latitude, pos.coords.longitude);
    }, _=> alert('No se pudo obtener ubicaci√≥n'));
  }
  function addManual(){
    const la=parseFloat(document.getElementById('lat').value), lo=parseFloat(document.getElementById('lng').value);
    if(Number.isNaN(la)||Number.isNaN(lo)){ alert('Ingresa lat/lng v√°lidas'); return; }
    savePoint(la, lo);
  }
  function savePoint(lat,lng){
    const data = JSON.parse(localStorage.getItem(MAP_KEY)||'[]'); data.push({lat,lng,t:Date.now()});
    localStorage.setItem(MAP_KEY, JSON.stringify(data)); loadMarkers();
  }

  /* ===== REPORTE ===== */
  function renderReporte(){
    pageTitle.textContent='Reporte de p√©rdida'; pageDesc.textContent='Genera un p√≥ster bonito para difundir.';
    grid.innerHTML='';
    const prof = JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}');
    const lost = JSON.parse(localStorage.getItem(LOST_KEY)||'{"lost":false}');
    const species = localStorage.getItem(SPECIES_KEY)||'cat';
    const color = species==='cat' ? 'linear-gradient(135deg,#ffd1dc,#dbeafe)' : 'linear-gradient(135deg,#fff1b5,#d1fae5)';
    const card=document.createElement('article'); card.className='card'; card.innerHTML=`
      <div class="card__body">
        <div id="reportCard" class="report" style="background-image:${color}">
          <div class="photo"><img src="${prof.photo||''}" onerror="this.src='https://via.placeholder.com/140x140?text=Sin+foto'"/></div>
          <div>
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
              <h2 style="margin:0">${prof.name||'Mi mascota'}</h2>
              ${JSON.parse(localStorage.getItem(LOST_KEY)||'{}').lost ? `<span class="badge-lost"><i class="bi bi-exclamation-triangle-fill"></i> PERDIDO</span>` : `<span class="muted">Estado: no perdido</span>`}
            </div>
            <p class="muted" style="margin:.4rem 0 0">Edad: ${prof.age||'‚Äî'} ‚Ä¢ Raza: ${prof.breed||'‚Äî'}</p>
            <p class="muted">Contacto: ${prof.phone||'‚Äî'} ${prof.email? '‚Ä¢ '+prof.email : ''}</p>
            <p style="margin:.4rem 0 0">${prof.notes||''}</p>
            ${lost.lost && lost.lost_since ? `<p class="muted">Desde: ${new Date(lost.lost_since).toLocaleString()}</p>`:''}
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button class="btn" onclick="downloadReportPNG()"><i class="bi bi-download"></i> Descargar PNG</button>
          <button class="btn" onclick="window.print()"><i class="bi bi-printer"></i> Imprimir</button>
        </div>
      </div>`;
    grid.appendChild(card);
  }
  async function downloadReportPNG(){
    const node=document.getElementById('reportCard');
    const canvas=await html2canvas(node,{backgroundColor:null, scale:2});
    const link=document.createElement('a');
    link.download='reporte-mascota.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  }

  /* ===== SECCIONES ===== */
  function loadSection(name){
    const species=localStorage.getItem(SPECIES_KEY)||'cat';
    // t√≠tulo + desc
    const descs={
      inicio: species==='cat' ? 'Recomendaciones para tu gato.' : 'Recomendaciones para tu perro.',
      salud:  species==='cat' ? 'Enfermedades/prevenci√≥n en gatos.' : 'Enfermedades/prevenci√≥n en perros.',
      dieta:  species==='cat' ? 'Dieta espec√≠fica por etapas felinas.' : 'Dieta espec√≠fica por talla/edad.',
      perfil: 'Completa y guarda los datos de tu mascota.',
      mapa:   'Registra ubicaciones de avistamiento.',
      reporte:'Crea un p√≥ster hermoso con tus datos.'
    };
    pageTitle.textContent = name[0].toUpperCase()+name.slice(1);
    pageDesc.textContent  = descs[name]||'';

    if (name==='perfil') return renderPerfil();
    if (name==='mapa')   return renderMapa();
    if (name==='reporte')return renderReporte();

    // secciones con grid + skeleton
    grid.innerHTML=''; grid.appendChild(skeleton(8));
    setTimeout(()=>{
      grid.innerHTML='';
      const list = name==='inicio' ? copy[species].inicio
                  : name==='salud' ? copy[species].salud
                  : name==='dieta' ? copy[species].dieta
                  : [];
      // si est√° vac√≠o, muestra dummy
      grid.appendChild(cardList(list.length? list : ['Contenido pr√≥ximamente','Mantente atento','Nuevo m√≥dulo']));
      observeLazy();
    }, 600 + Math.random()*400);
  }

  // lazy load more (al acercarse al final)
  let io;
  function observeLazy(){
    io && io.disconnect();
    io = new IntersectionObserver((entries)=>{
      for (const e of entries){ if (e.isIntersecting){ io.disconnect(); loadMore(); setTimeout(observeLazy, 900);} }
    }, {rootMargin:'600px 0px'});
    io.observe(grid.lastElementChild || grid);
  }

  /* ===== INIT ===== */
  function initFromStorage(){
    const sp = localStorage.getItem(SPECIES_KEY);
    const id = localStorage.getItem(COLLAR_KEY);
    if (sp && id) { applySpecies(sp); onboarding.classList.add('hidden'); }
  }
  const THEME_INIT = ()=> applyTheme(localStorage.getItem(THEME_KEY)||'light');

  addEventListener('load', ()=>{
    THEME_INIT();
    initFromStorage();
    moveBgTo(dock.querySelector('.is-active')||btns[0]);
    updateTooltipSide();
    // si ya hab√≠a collar, carga directamente
    if (localStorage.getItem(COLLAR_KEY)) loadSection('inicio');
  });
</script>
</body>
</html>
